"""
This test script makes sure that the detection result is the same as the visualization results.
"""
import numpy as np

from metadrive.envs.metadrive_env import MetaDriveEnv

pg_gt_1 = [
    0.1267634779214859,
    0.11392685770988464,
    0.1044268012046814,
    0.0990290567278862,
    0.0957709476351738,
    0.09482643008232117,
    0.09539368003606796,
    0.09751298278570175,
    0.10115782171487808,
    0.10696601122617722,
    0.11759728938341141,
    0.13363347947597504,
    0.15761184692382812,
    0.20706525444984436,
    1.0,
    0.8871590495109558,
    0.6441130638122559,
    0.5090571641921997,
    0.40979763865470886,
    0.33093956112861633,
    0.2702655494213104,
    0.2258983850479126,
    0.19412241876125336,
    0.17001909017562866,
    0.15213795006275177,
    0.1396520584821701,
    0.13039246201515198,
    0.12283173948526382,
    0.11785661429166794,
    0.11501174420118332,
    0.11405755579471588,
    0.1149156242609024,
    0.11626093089580536,
    0.11947877705097198,
    0.12490776181221008,
    0.13305042684078217,
    0.14444735646247864,
    0.15821027755737305,
    0.1776970475912094,
    0.20531244575977325,
    0.24059288203716278,
    0.2903081476688385,
    0.3573307991027832,
    0.44379305839538574,
    0.5522155165672302,
    0.6746124625205994,
    0.8479273319244385,
    0.28093159198760986,
    0.18419356644153595,
    0.14614278078079224,
    0.5,
    0.013087914325296879,
    0.5,
    0.5,
    0.5,
    1.3328003660717513e-06,
    0.1267634779214859,
    0.028144173324108124,
    0.02637900784611702,
    0.025196190923452377,
    0.024484261870384216,
    0.02418249100446701,
    0.024266058579087257,
    0.024741727858781815,
    0.025649012997746468,
    0.027068454772233963,
    0.02914074808359146,
    0.03210511431097984,
    0.15761184692382812,
    0.20706525444984436,
    1.0,
    0.08154026418924332,
    0.4780718982219696,
    0.3471904695034027,
    0.40979763865470886,
    0.33093956112861633,
    0.12774471938610077,
    0.2258983850479126,
    0.19412241876125336,
    0.0699082463979721,
    0.061508193612098694,
    0.05566595867276192,
    0.13039246201515198,
    0.12283173948526382,
    0.11785661429166794,
    0.11501174420118332,
    0.11405755579471588,
    0.1149156242609024,
    0.04554778337478638,
    0.0469503253698349,
    0.04925423115491867,
    0.052669137716293335,
    0.05756601318717003,
    0.15821027755737305,
    0.1776970475912094,
    0.20531244575977325,
    0.10870824009180069,
    0.2903081476688385,
    0.19524239003658295,
    0.44379305839538574,
    0.3930048644542694,
    0.1347915232181549,
    0.06913679838180542,
    0.28093159198760986,
    0.18419356644153595,
    0.14614278078079224,
    0.0045279692858457565,
    0.43315500020980835,
    0.0,
    0.5,
    0.5,
    0.2699264585971832,
    0.41499999165534973,
    0.0,
    0.5,
    0.5,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
]

pg_gt_2 = [
    0.10000000149011612,
    0.10999999940395355,
    0.10999999940395355,
    0.10999999940395355,
    0.11999999731779099,
    0.12999999523162842,
    0.14000000059604645,
    0.1599999964237213,
    0.1899999976158142,
    0.23999999463558197,
    0.3400000035762787,
    0.5600000023841858,
    1.0,
    1.0,
    0.5600000023841858,
    0.3400000035762787,
    0.23999999463558197,
    0.1899999976158142,
    0.1599999964237213,
    0.14000000059604645,
    0.12999999523162842,
    0.11999999731779099,
    0.10999999940395355,
    0.10999999940395355,
    0.10999999940395355,
    0.10000000149011612,
    0.10999999940395355,
    0.10999999940395355,
    0.10999999940395355,
    0.11999999731779099,
    0.12999999523162842,
    0.14000000059604645,
    0.1599999964237213,
    0.1899999976158142,
    0.23999999463558197,
    0.3400000035762787,
    0.5199999809265137,
    0.7099999785423279,
    0.8999999761581421,
    1.0,
    0.3400000035762787,
    0.23999999463558197,
    0.1899999976158142,
    0.1599999964237213,
    0.14000000059604645,
    0.12999999523162842,
    0.11999999731779099,
    0.10999999940395355,
    0.10999999940395355,
    0.10999999940395355,
    0.5,
    0.009999999776482582,
    0.5,
    0.5,
    0.5,
    0.0,
    0.10000000149011612,
    0.10999999940395355,
    0.10999999940395355,
    0.10999999940395355,
    0.11999999731779099,
    0.12999999523162842,
    0.14000000059604645,
    0.05000000074505806,
    0.05999999865889549,
    0.07999999821186066,
    0.3400000035762787,
    0.5600000023841858,
    0.5600000023841858,
    0.5600000023841858,
    0.5600000023841858,
    0.3400000035762787,
    0.07999999821186066,
    0.05999999865889549,
    0.05000000074505806,
    0.14000000059604645,
    0.12999999523162842,
    0.11999999731779099,
    0.10999999940395355,
    0.10999999940395355,
    0.10999999940395355,
    0.10000000149011612,
    0.029999999329447746,
    0.03999999910593033,
    0.03999999910593033,
    0.03999999910593033,
    0.03999999910593033,
    0.05000000074505806,
    0.1599999964237213,
    0.1899999976158142,
    0.23999999463558197,
    0.10999999940395355,
    0.18000000715255737,
    0.47999998927116394,
    0.8999999761581421,
    0.18000000715255737,
    0.10999999940395355,
    0.23999999463558197,
    0.1899999976158142,
    0.1599999964237213,
    0.05000000074505806,
    0.03999999910593033,
    0.03999999910593033,
    0.03999999910593033,
    0.03999999910593033,
    0.029999999329447746,
    0.30000001192092896,
    0.5,
    0.0,
    0.5,
    0.5,
    0.699999988079071,
    0.5,
    0.0,
    0.5,
    0.5,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
]

pg_gt_3 = [
    0.17424996197223663, 0.17563384771347046, 0.179901123046875, 0.18740931153297424, 0.19884595274925232,
    0.21538487076759338, 0.23903638124465942, 0.273365318775177, 0.32519838213920593, 0.40924975275993347,
    0.5638853311538696, 1.0, 1.0, 0.5454577803611755, 0.18278196454048157, 0.11083516478538513, 0.08044067770242691,
    0.06391915678977966, 0.05373150855302811, 0.04698386788368225, 0.04233507066965103, 0.03907269984483719,
    0.03683317080140114, 0.03535793721675873, 0.034397244453430176, 0.03412747383117676, 0.034522198140621185,
    0.0353609174489975, 0.036836810410022736, 0.03908421844244003, 0.04233531653881073, 0.04698418080806732,
    0.05373169109225273, 0.06391977518796921, 0.08044077455997467, 0.11082261800765991, 0.18277062475681305,
    0.45523008704185486, 0.7089459300041199, 0.8811144232749939, 1.0, 0.40924930572509766, 0.325198233127594,
    0.2732689678668976, 0.23903624713420868, 0.21538473665714264, 0.19884586334228516, 0.1874106079339981,
    0.17990022897720337, 0.17563492059707642, 0.49999988079071045, 0.012532129883766174, 0.5, 0.5, 0.5,
    1.3244441561255371e-06, 0.17424996197223663, 0.03450844809412956, 0.035360947251319885, 0.03683680295944214,
    0.03908339887857437, 0.04233534261584282, 0.04698362201452255, 0.273365318775177, 0.19455832242965698,
    0.40924975275993347, 0.1108340248465538, 0.18278250098228455, 0.5611181855201721, 0.5454577803611755,
    0.18278196454048157, 0.11083516478538513, 0.08044067770242691, 0.06391915678977966, 0.05373150855302811,
    0.04698386788368225, 0.04233507066965103, 0.03907269984483719, 0.03683317080140114, 0.03535793721675873,
    0.034397244453430176, 0.03412747383117676, 0.034522198140621185, 0.0353609174489975, 0.036836810410022736,
    0.03908421844244003, 0.04233531653881073, 0.04698418080806732, 0.05373169109225273, 0.06391977518796921,
    0.08044077455997467, 0.11082261800765991, 0.18277062475681305, 0.45523008704185486, 0.7089459300041199,
    0.7421090602874756, 0.7847582697868347, 0.08044064044952393, 0.0639198049902916, 0.053731828927993774,
    0.23903624713420868, 0.1288066953420639, 0.11896516382694244, 0.11209990084171295, 0.17990022897720337,
    0.17563492059707642, 0.3000001609325409, 0.43000006675720215, 0.0, 0.5, 0.5, 0.699988842010498, 0.4299999475479126,
    0.0, 0.5, 0.5, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0
]


def test_pg_map(render=False):
    env = MetaDriveEnv(
        {
            "use_render": render,
            # "debug_static_world": render,
            # "debug": render,
            "num_scenarios": 1,
            "traffic_density": 0,
            "start_seed": 74,
            "map": 1,
            "vehicle_config": {
                "lidar": dict(num_lasers=10, distance=50),
                "side_detector": dict(num_lasers=50, distance=50),
                "lane_line_detector": dict(num_lasers=50, distance=50),
            },
        }
    )
    try:
        env.reset()
        env.agent.set_position([73, 12])
        for s in range(1, 5):
            o, r, tm, tc, info = env.step([0, 0])

        print("[")
        for _o in o.tolist():
            print("{},".format(_o))
        print("]")
        np.testing.assert_almost_equal(pg_gt_1, np.round(o, 2), decimal=2)

        env.agent.set_position([30, 3.5])
        for s in range(1, 5):
            o, r, tm, tc, info = env.step([0, 0])
        print("[")
        for _o in o:
            print("{},".format(round(_o, 2)))
        print("]")
        np.testing.assert_almost_equal(np.array(pg_gt_2), o, decimal=2)

        env.agent.set_position([30, 10.5])
        for s in range(1, 5):
            o, r, tm, tc, info = env.step([0, 0])
        print("[")
        for ind, _o in enumerate(o):
            print("{:.2f}, GT: {:.2f}".format(_o, pg_gt_3[ind]))
        print("]")

        print(o.tolist())

        np.testing.assert_almost_equal(np.array(pg_gt_3), o, decimal=2)
    finally:
        env.close()


nuscenes_gt_1 = [
    0.09075836837291718,
    0.09217655658721924,
    0.09512815624475479,
    0.09983516484498978,
    0.10680326074361801,
    0.11676304042339325,
    0.13101108372211456,
    0.15133066475391388,
    0.1828141212463379,
    0.23759107291698456,
    0.3464219272136688,
    0.5152920484542847,
    1.0,
    1.0,
    0.7216349840164185,
    0.4785699248313904,
    0.3620630204677582,
    0.2945554852485657,
    0.2518192529678345,
    0.22320537269115448,
    0.20315533876419067,
    0.18915221095085144,
    0.1796053946018219,
    0.17358174920082092,
    0.1705060601234436,
    0.17026464641094208,
    0.17269740998744965,
    0.17804943025112152,
    0.1867835521697998,
    0.1997312605381012,
    0.21826286613941193,
    0.24478337168693542,
    0.28362220525741577,
    0.3439479172229767,
    0.44482824206352234,
    1.0,
    0.2166164666414261,
    0.3294956684112549,
    0.5083940625190735,
    0.6360813975334167,
    0.2537195086479187,
    0.1899668127298355,
    0.1564241647720337,
    0.13358616828918457,
    0.11820273101329803,
    0.10741100460290909,
    0.10005706548690796,
    0.09534399211406708,
    0.09228239208459854,
    0.0907929316163063,
    0.5260613560676575,
    0.4140831232070923,
    0.5,
    0.5,
    0.5,
    5.327035069058184e-06,
    0.09075836837291718,
    0.09217655658721924,
    0.09512815624475479,
    0.09983516484498978,
    0.10680326074361801,
    0.11676304042339325,
    0.13101108372211456,
    0.15133066475391388,
    0.1828141212463379,
    0.23759107291698456,
    0.3464219272136688,
    0.5152920484542847,
    1.0,
    1.0,
    0.13423743844032288,
    0.08499369770288467,
    0.0641968622803688,
    0.17124241590499878,
    0.2518192529678345,
    0.12980437278747559,
    0.11819363385438919,
    0.18915221095085144,
    0.03174185752868652,
    0.03066714107990265,
    0.03012210875749588,
    0.030061468482017517,
    0.030481763184070587,
    0.03141583874821663,
    0.032944608479738235,
    0.03521450608968735,
    0.03834288939833641,
    0.24478337168693542,
    0.28362220525741577,
    0.3439479172229767,
    0.26837339997291565,
    1.0,
    0.2166164666414261,
    0.3294956684112549,
    0.5083940625190735,
    0.6360813975334167,
    0.2537195086479187,
    0.1899668127298355,
    0.1564241647720337,
    0.13358616828918457,
    0.11820273101329803,
    0.10741100460290909,
    0.10005706548690796,
    0.09534399211406708,
    0.09228239208459854,
    0.0907929316163063,
    0.5623959898948669,
    0.5623959898948669,
    0.5956567525863647,
    0.5956567525863647,
    0.6289005875587463,
    0.6289005875587463,
    0.6621062755584717,
    0.6621062755584717,
    0.6952372789382935,
    0.6952372789382935,
    0.7282377481460571,
    0.7282377481460571,
    0.7610746622085571,
    0.7610746622085571,
    0.7936805486679077,
    0.7936805486679077,
    0.8258141875267029,
    0.8258141875267029,
    0.5182746052742004,
    0.5082993507385254,
    0.0,
    0.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
]
nuscenes_gt_2 = [
    1.0,
    0.779081404209137,
    0.4008123576641083,
    0.4965006411075592,
    0.2193922996520996,
    0.1830165535211563,
    0.27383944392204285,
    0.243718221783638,
    0.22272785007953644,
    0.20793406665325165,
    0.19818702340126038,
    0.19207695126533508,
    0.1892271488904953,
    0.18984796106815338,
    0.1934981793165207,
    0.20042887330055237,
    0.11704640090465546,
    0.1256762593984604,
    0.1380302459001541,
    0.15554210543632507,
    0.1821221262216568,
    0.22327348589897156,
    0.294590562582016,
    0.4437068700790405,
    0.9753552079200745,
    0.12470095604658127,
    0.04193984344601631,
    0.03848263621330261,
    0.03607578203082085,
    0.034464310854673386,
    0.03349597752094269,
    0.03308868035674095,
    0.033208273351192474,
    0.03570190817117691,
    0.04525022581219673,
    0.06312886625528336,
    1.0,
    0.9281278848648071,
    0.4757794439792633,
    0.326820969581604,
    0.2528233230113983,
    0.2089240849018097,
    0.1803993582725525,
    0.16096088290214539,
    0.1474027931690216,
    0.1379578709602356,
    0.13127265870571136,
    0.12699860334396362,
    0.12540613114833832,
    0.1267486810684204,
    0.39884063601493835,
    0.39179351925849915,
    0.5,
    0.5,
    0.5,
    2.9294713385752402e-05,
    1.0,
    0.779081404209137,
    0.176986426115036,
    0.4965006411075592,
    0.2193922996520996,
    0.1830165535211563,
    0.27383944392204285,
    0.243718221783638,
    0.22272785007953644,
    0.20793406665325165,
    0.19818702340126038,
    0.19207695126533508,
    0.1892271488904953,
    0.18984796106815338,
    0.1934981793165207,
    0.20042887330055237,
    0.11704640090465546,
    0.1256762593984604,
    0.1380302459001541,
    0.15554210543632507,
    0.1821221262216568,
    0.22327348589897156,
    0.294590562582016,
    0.4437068700790405,
    0.9753552079200745,
    0.12470095604658127,
    0.04193984344601631,
    0.03848263621330261,
    0.03607578203082085,
    0.034464310854673386,
    0.03349597752094269,
    0.03308868035674095,
    0.033208273351192474,
    0.03570190817117691,
    0.04525022581219673,
    0.06312886625528336,
    1.0,
    0.9281278848648071,
    0.4757794439792633,
    0.326820969581604,
    0.2528233230113983,
    0.2089240849018097,
    0.1803993582725525,
    0.16096088290214539,
    0.1474027931690216,
    0.1379578709602356,
    0.13127265870571136,
    0.12699860334396362,
    0.12540613114833832,
    0.1267486810684204,
    0.4397680163383484,
    0.4397680163383484,
    0.46192362904548645,
    0.46192362904548645,
    0.48389288783073425,
    0.48389288783073425,
    0.5055355429649353,
    0.5055355429649353,
    0.5267529487609863,
    0.5267529487609863,
    0.5474106073379517,
    0.5474106073379517,
    0.5674235820770264,
    0.5674235820770264,
    0.5867453813552856,
    0.5867453813552856,
    0.6053695678710938,
    0.6053695678710938,
    0.0,
    0.46757614612579346,
    0.0,
    0.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
    1.0,
]


def test_nuscenes(render=False):
    from metadrive.engine.asset_loader import AssetLoader
    from metadrive.envs.scenario_env import ScenarioEnv

    NuScenesEnv = ScenarioEnv

    env = NuScenesEnv(
        {
            "use_render": render,
            # "agent_policy": ReplayEgoCarPolicy,
            "no_traffic": True,
            "debug_static_world": render,
            "debug": render,
            "show_sidewalk": True,
            "show_crosswalk": True,
            "camera_dist": 9,
            "start_scenario_index": 0,
            "num_scenarios": 10,
            "horizon": 1000,
            "vehicle_config": dict(
                show_navi_mark=False,
                lidar=dict(num_lasers=10, distance=50),
                lane_line_detector=dict(num_lasers=50, distance=50),
                side_detector=dict(num_lasers=50, distance=50)
            ),
            "data_directory": AssetLoader.file_path("nuscenes", unix_style=False),
        }
    )
    try:
        env.reset(seed=0)
        env.agent.set_position([-9.4, -27.2])
        for s in range(1, 5):
            o, r, tm, tc, info = env.step([0, 0])

        print("[")
        for _o in o.tolist():
            print("{},".format(_o))
        print("]")
        np.testing.assert_almost_equal(nuscenes_gt_1, o, decimal=3)

        env.reset(seed=1)
        env.agent.set_position([79.96, -6.2])
        for s in range(1, 5):
            o, r, tm, tc, info = env.step([0, 0])

        print("[")
        for _o in o.tolist():
            print("{},".format(_o))
        print("]")
        np.testing.assert_almost_equal(nuscenes_gt_2, o, decimal=3)
    finally:
        env.close()


if __name__ == '__main__':
    test_nuscenes(False)
    # test_pg_map(False)
